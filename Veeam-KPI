# =====================================================================
# VEEAM KPI DASHBOARD REPORT - PowerShell ISE Edition
# Version compatible : Veeam Backup & Replication 12.3.1.1139
# Auteur : ChatGPT (adapté pour exécution manuelle)
# =====================================================================

# --- Chargement du module Veeam ---
try {
    if (-not (Get-Module -ListAvailable -Name Veeam.Backup.PowerShell)) {
        Write-Host " Module Veeam.Backup.PowerShell introuvable. Installe-le avant de continuer." -ForegroundColor Red
        break
    }
    Import-Module Veeam.Backup.PowerShell -ErrorAction Stop
    Connect-VBRServer -Server localhost | Out-Null
    Write-Host " Connecté à Veeam Backup Server"
} catch {
    Write-Host "Erreur lors de la connexion à Veeam : $($_.Exception.Message)" -ForegroundColor Red
    break
}

# --- Récupération des Jobs actifs ---
$backupJobs = Get-VBRJob | Where-Object { $_.JobType -eq "Backup" -and $_.IsScheduleEnabled -eq $true }
$tapeJobs   = Get-VBRTapeJob | Where-Object { $_.IsScheduleEnabled -eq $true }
$replicaJobs = Get-VBRJob | Where-Object { $_.JobType -eq "Replica" -and $_.IsScheduleEnabled -eq $true }

# --- Fonction pour calculer le taux de réussite des jobs ---
function Get-JobSuccessRate($jobs) {
    $total = $jobs.Count
    if ($total -eq 0) { return @{Success = 0; Failed = 0} }

    $sessions = $jobs | ForEach-Object { Get-VBRJobSession -Job $_ | Sort-Object EndTime -Descending | Select-Object -First 1 }
    $success = ($sessions | Where-Object { $_.Result -eq "Success" }).Count
    $failed  = ($sessions | Where-Object { $_.Result -ne "Success" }).Count
    return @{
        Success = [math]::Round(($success / $total) * 100, 0)
        Failed  = [math]::Round(($failed / $total) * 100, 0)
    }
}

$backupStats = Get-JobSuccessRate $backupJobs
$tapeStats   = Get-JobSuccessRate $tapeJobs
$replicaStats = Get-JobSuccessRate $replicaJobs

# --- Repositories ---
$repositories = Get-VBRBackupRepository | ForEach-Object {
    $free = $_.Info.FreeSpace
    $cap  = $_.Info.Capacity
    [PSCustomObject]@{
        Name = $_.Name
        UsedPercent = [math]::Round((($cap - $free) / $cap) * 100, 1)
        FreeTB = [math]::Round($free / 1TB, 2)
        CapacityTB = [math]::Round($cap / 1TB, 2)
    }
}

# --- Tape Pools ---
$tapePools = Get-VBRTapeMediaPool | ForEach-Object {
    $tapes = Get-VBRTapeMedium -MediaPool $_
    $used = ($tapes | Where-Object { $_.MediaPoolId -ne $null }).Count
    $total = $tapes.Count
    [PSCustomObject]@{
        Name = $_.Name
        UsedPercent = if ($total -gt 0) { [math]::Round(($used / $total) * 100, 1) } else { 0 }
        TotalTapes = $total
    }
}

# --- HTML Color Functions ---
function Get-GaugeHTML($title, $value, $color) {
    return @"
    <div style='display:inline-block; text-align:center; margin:20px;'>
        <svg width='120' height='120' viewBox='0 0 36 36'>
            <path d='M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831'
            fill='none' stroke='#eee' stroke-width='2'/>
            <path d='M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831'
            fill='none' stroke='$color' stroke-width='2' stroke-dasharray='$value,100' />
            <text x='18' y='20.35' font-size='8' text-anchor='middle' fill='$color'>$value%</text>
        </svg>
        <div style='font-weight:bold; color:$color;'>$title</div>
    </div>
"@
}

# --- Génération du rapport HTML ---
$html = @"
<html><head>
<style>
body { font-family: Arial; background:#f8f8f8; text-align:center; }
h2 { color:#2d862d; }
.section { border:1px solid #ddd; background:white; padding:15px; margin:15px; border-radius:10px; display:inline-block; }
</style>
</head><body>
<h2> Tableau de bord Veeam - Rapport KPI</h2>
<div class='section'>
<h3> Sauvegardes sur disque</h3>
$(Get-GaugeHTML "Réussite" $($backupStats.Success) "#00b336")
$(Get-GaugeHTML "Échecs" $($backupStats.Failed) "#e00000")
</div>
<div class='section'>
<h3> Sauvegardes sur bande</h3>
$(Get-GaugeHTML "Réussite" $($tapeStats.Success) "#00b336")
$(Get-GaugeHTML "Échecs" $($tapeStats.Failed) "#e00000")
</div>
<div class='section'>
<h3> Réplications</h3>
$(Get-GaugeHTML "Réussite" $($replicaStats.Success) "#00b336")
$(Get-GaugeHTML "Échecs" $($replicaStats.Failed) "#e00000")
</div>
<div class='section'>
<h3> Utilisation des Repositories</h3>
<table border='1' cellspacing='0' cellpadding='5' align='center'>
<tr><th>Nom</th><th>Utilisation (%)</th><th>Libre (TB)</th><th>Capacité (TB)</th></tr>
$(foreach ($r in $repositories) {
    "<tr><td>$($r.Name)</td><td>$($r.UsedPercent)%</td><td>$($r.FreeTB)</td><td>$($r.CapacityTB)</td></tr>"
})
</table>
</div>
<div class='section'>
<h3> Pool de bandes</h3>
<table border='1' cellspacing='0' cellpadding='5' align='center'>
<tr><th>Nom</th><th>Utilisation (%)</th><th>Nombre total de bandes</th></tr>
$(foreach ($t in $tapePools) {
    "<tr><td>$($t.Name)</td><td>$($t.UsedPercent)%</td><td>$($t.TotalTapes)</td></tr>"
})
</table>
</div>
</body></html>
"@

# --- Enregistrement du rapport ---
$reportPath = "C:\Reports\Veeam_KPI_Report.html"
New-Item -ItemType Directory -Force -Path (Split-Path $reportPath) | Out-Null
$html | Out-File -FilePath $reportPath -Encoding UTF8
Write-Host " Rapport généré : $reportPath"
